<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutor Dashboard - EduConnect</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-content">
                <div class="logo">
                    <span class="logo-icon">üìö</span>
                    <span class="logo-text">EduConnect</span>
                </div>
                <div class="nav-links">
                    <a href="#" onclick="showSection('dashboard')">Dashboard</a>
                    <a href="#" onclick="showSection('sessions')">My Sessions</a>
                    <a href="#" onclick="showSection('students')">Students</a>
                    <a href="#" onclick="showSection('resources')">Resources</a>
                    <a href="#" onclick="showSection('messages')">Messages <span id="messagesBadge"></span></a>
                </div>
                <div class="nav-buttons">
                    <button onclick="showSection('notifications')" class="btn-outline">
                        üîî <span id="notificationsBadge"></span>
                    </button>
                    <button onclick="auth.logout()" class="btn-primary">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard -->
    <div class="dashboard">
        <div class="dashboard-header">
            <div class="container">
                <div class="dashboard-welcome">
                    <div>
                        <h1>Welcome, <span id="userName"></span>!</h1>
                        <p>Manage your tutoring sessions and students</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-content">
            <div class="container">
                <div class="dashboard-grid">
                    <!-- Sidebar -->
                    <aside class="sidebar">
                        <ul class="sidebar-menu">
                            <li><a href="#" class="active" onclick="showSection('dashboard')">
                                <span>üìä</span> Dashboard
                            </a></li>
                            <li><a href="#" onclick="showSection('profile')">
                                <span>üë§</span> My Profile
                            </a></li>
                            <li><a href="#" onclick="showSection('sessions')">
                                <span>üìÖ</span> My Sessions
                            </a></li>
                            <li><a href="#" onclick="showSection('create-session')">
                                <span>‚ûï</span> Create Session
                            </a></li>
                            <li><a href="#" onclick="showSection('students')">
                                <span>üë•</span> My Students
                            </a></li>
                            <li><a href="#" onclick="showSection('reviews')">
                                <span>‚≠ê</span> My Reviews
                            </a></li>
                            <li><a href="#" onclick="showSection('resources')">
                                <span>üìö</span> My Resources
                            </a></li>
                            <li><a href="#" onclick="showSection('upload')">
                                <span>‚¨ÜÔ∏è</span> Upload Resource
                            </a></li>
                            <li><a href="#" onclick="showSection('messages')">
                                <span>üí¨</span> Messages
                            </a></li>
                            <li><a href="#" onclick="showSection('notifications')">
                                <span>üîî</span> Notifications
                            </a></li>
                        </ul>
                    </aside>

                    <!-- Main Content -->
                    <main class="main-content">
                        <!-- Dashboard Section -->
                        <div id="dashboardSection" class="content-section">
                            <div class="content-header">
                                <h2>Statistics Overview</h2>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                                <div class="card" style="text-align: center;">
                                    <div style="font-size: 36px; color: #6366f1;">üìÖ</div>
                                    <h3 id="statTotalSessions" style="font-size: 32px; margin: 10px 0;">0</h3>
                                    <p style="color: #6b7280;">Total Sessions</p>
                                </div>
                                <div class="card" style="text-align: center;">
                                    <div style="font-size: 36px; color: #10b981;">üë•</div>
                                    <h3 id="statTotalStudents" style="font-size: 32px; margin: 10px 0;">0</h3>
                                    <p style="color: #6b7280;">Total Students</p>
                                </div>
                                <div class="card" style="text-align: center;">
                                    <div style="font-size: 36px; color: #f59e0b;">üìö</div>
                                    <h3 id="statTotalResources" style="font-size: 32px; margin: 10px 0;">0</h3>
                                    <p style="color: #6b7280;">Resources Shared</p>
                                </div>
                                <div class="card" style="text-align: center;">
                                    <div style="font-size: 36px; color: #ef4444;">‚≠ê</div>
                                    <h3 id="statRating" style="font-size: 32px; margin: 10px 0;">5.0</h3>
                                    <p style="color: #6b7280;">Average Rating</p>
                                </div>
                                <div class="card" style="text-align: center;">
                                    <div style="font-size: 36px; color: #8b5cf6;">‚ù§Ô∏è</div>
                                    <h3 id="statFavorites" style="font-size: 32px; margin: 10px 0;">0</h3>
                                    <p style="color: #6b7280;">Favorites</p>
                                </div>
                            </div>

                            <h3 style="margin: 30px 0 15px;">Upcoming Sessions</h3>
                            <div id="upcomingSessionsList"></div>
                        </div>

                        <!-- Profile Section -->
                        <div id="profileSection" class="content-section" style="display: none;">
                            <div class="content-header">
                                <h2>Edit Profile</h2>
                            </div>
                            <div style="max-width: 700px;">
                                <div id="profileAlert"></div>
                                <form id="profileForm" onsubmit="handleProfileUpdate(event)">
                                    <div class="form-group">
                                        <label>Name</label>
                                        <input type="text" id="profileName" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Email</label>
                                        <input type="email" id="profileEmail" class="form-control" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label>Bio / Description</label>
                                        <textarea id="profileDescription" class="form-control" rows="4" placeholder="Tell students about yourself..."></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Subjects (comma-separated)</label>
                                        <input type="text" id="profileSubjects" class="form-control" placeholder="e.g., Mathematics, Physics, Chemistry">
                                    </div>
                                    <button type="submit" class="btn-primary">Update Profile</button>
                                </form>
                            </div>
                        </div>

                        <!-- Sessions Section -->
                        <div id="sessionsSection" class="content-section" style="display: none;">
                            <div class="content-header">
                                <h2>My Sessions</h2>
                                <button onclick="showSection('create-session')" class="btn-primary">+ Create New Session</button>
                            </div>
                            <div id="sessionsList"></div>
                        </div>

                        <!-- Create Session Section -->
                        <div id="createSessionSection" class="content-section" style="display: none;">
                            <div class="content-header">
                                <h2>Create New Session</h2>
                            </div>
                            <div style="max-width: 700px;">
                                <div id="sessionAlert"></div>
                                <form id="sessionForm" onsubmit="handleCreateSession(event)">
                                    <div class="form-group">
                                        <label>Session Title</label>
                                        <input type="text" id="sessionTitle" class="form-control" required placeholder="e.g., Introduction to Calculus">
                                    </div>
                                    <div class="form-group">
                                        <label>Subject</label>
                                        <select id="sessionSubject" class="form-control" required>
                                            <option value="">Select a subject</option>
                                            <option value="Mathematics">Mathematics</option>
                                            <option value="Science">Science</option>
                                            <option value="Programming">Programming</option>
                                            <option value="English">English</option>
                                            <option value="History">History</option>
                                            <option value="Chemistry">Chemistry</option>
                                            <option value="Physics">Physics</option>
                                            <option value="Biology">Biology</option>
                                            <option value="Art">Art</option>
                                            <option value="Music">Music</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Description</label>
                                        <textarea id="sessionDescription" class="form-control" rows="4" required placeholder="Describe what students will learn..."></textarea>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div class="form-group">
                                            <label>Date</label>
                                            <input type="date" id="sessionDate" class="form-control" required>
                                        </div>
                                        <div class="form-group">
                                            <label>Time</label>
                                            <input type="time" id="sessionTime" class="form-control" required>
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div class="form-group">
                                            <label>Duration</label>
                                            <select id="sessionDuration" class="form-control" required>
                                                <option value="30 minutes">30 minutes</option>
                                                <option value="60 minutes" selected>60 minutes</option>
                                                <option value="90 minutes">90 minutes</option>
                                                <option value="120 minutes">120 minutes</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Max Students</label>
                                            <input type="number" id="sessionMaxStudents" class="form-control" required min="1" max="50" value="10">
                                        </div>
                                    </div>
                                    <button type="submit" class="btn-primary">Create Session</button>
                                </form>
                            </div>
                        </div>

                        <!-- Students Section -->
                        <div id="studentsSection" class="content-section" style="display: none;">
                            <div class="content-header">
                                <h2>My Students</h2>
                            </div>
                            <div id="studentsList"></div>
                        </div>

                        <!-- Reviews Section -->
                        <div id="reviewsSection" class="content-section" style="display: none;">
                            <div class="content-header">
                                <h2>My Reviews</h2>
                            </div>
                            
                            <div id="reviewsStats" class="rating-summary"></div>
                            
                            <div id="reviewsList"></div>
                        </div>

                        <!-- Resources Section -->
                        <div id="resourcesSection" class="content-section" style="display: none;">
                            <div class="content-header">
                                <h2>My Resources</h2>
                                <button onclick="showSection('upload')" class="btn-primary">+ Upload Resource</button>
                            </div>
                            <div id="resourcesList"></div>
                        </div>

                        <!-- Upload Resource Section -->
                        <div id="uploadSection" class="content-section" style="display: none;">
                            <div class="content-header">
                                <h2>Upload Educational Resource</h2>
                            </div>
                            <div style="max-width: 700px;">
                                <div id="uploadAlert"></div>
                                <form id="uploadForm" onsubmit="handleUpload(event)">
                                    <div class="form-group">
                                        <label>Resource Title</label>
                                        <input type="text" id="resourceTitle" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Description</label>
                                        <textarea id="resourceDescription" class="form-control" rows="4" required></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Subject</label>
                                        <select id="resourceSubject" class="form-control" required>
                                            <option value="">Select a subject</option>
                                            <option value="Mathematics">Mathematics</option>
                                            <option value="Science">Science</option>
                                            <option value="Programming">Programming</option>
                                            <option value="English">English</option>
                                            <option value="History">History</option>
                                            <option value="Chemistry">Chemistry</option>
                                            <option value="Physics">Physics</option>
                                            <option value="Biology">Biology</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>File Type</label>
                                        <select id="resourceFileType" class="form-control" required>
                                            <option value="">Select type</option>
                                            <option value="PDF">PDF Document</option>
                                            <option value="DOC">Word Document</option>
                                            <option value="PPT">Presentation</option>
                                            <option value="XLS">Spreadsheet</option>
                                            <option value="Video">Video</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>File Name (simulation)</label>
                                        <input type="text" id="resourceFileName" class="form-control" required placeholder="e.g., lecture-notes.pdf">
                                    </div>
                                    <button type="submit" class="btn-primary">Upload Resource</button>
                                </form>
                            </div>
                        </div>

                        <!-- Messages Section -->
                        <div id="messagesSection" class="content-section" style="display: none;">
                            <div class="content-header">
                                <h2>Messages</h2>
                            </div>
                            <div class="chat-container">
                                <div class="chat-list" id="chatList">
                                    <p style="color: #6b7280; text-align: center; padding: 20px;">No conversations yet</p>
                                </div>
                                <div class="chat-window">
                                    <div id="chatHeader" class="chat-header" style="display: none;">
                                        <h3 id="chatUserName"></h3>
                                    </div>
                                    <div id="chatMessages" class="chat-messages"></div>
                                    <div id="chatInputContainer" class="chat-input" style="display: none;">
                                        <input type="text" id="messageInput" class="form-control" placeholder="Type your message...">
                                        <button onclick="sendMessage()" class="btn-primary">Send</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notifications Section -->
                        <div id="notificationsSection" class="content-section" style="display: none;">
                            <div class="content-header">
                                <h2>Notifications</h2>
                                <button onclick="markAllAsRead()" class="btn-outline">Mark All as Read</button>
                            </div>
                            <ul id="notificationsList" class="notifications-list"></ul>
                        </div>
                    </main>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Session Modal -->
    <div id="editSessionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Session</h2>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="editSessionForm" onsubmit="handleUpdateSession(event)">
                <input type="hidden" id="editSessionId">
                <div class="form-group">
                    <label>Session Title</label>
                    <input type="text" id="editSessionTitle" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="editSessionDescription" class="form-control" rows="4" required></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="editSessionDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Time</label>
                        <input type="time" id="editSessionTime" class="form-control" required>
                    </div>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">Update Session</button>
            </form>
        </div>
    </div>

    <script src="js/storage.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/students.js"></script>
    <script src="js/tutors.js"></script>
    <script>
        // Check authentication
        if (!auth.requireTutor()) {
            // Will redirect if not authenticated or not a tutor
        }

        const currentUser = auth.getCurrentUser();
        let currentChatUser = null;
        let currentEditSessionId = null;

        // Initialize dashboard
        document.getElementById('userName').textContent = currentUser.name;
        loadDashboard();
        loadProfile();
        loadSessions();
        loadStudents();
        loadResources();
        updateNotificationsBadge();
        updateMessagesBadge();

        function loadDashboard() {
            const stats = tutorManager.getStatistics(currentUser.id);
            const favCount = tutorManager.getFavoritesCount(currentUser.id);
            
            if (stats) {
                document.getElementById('statTotalSessions').textContent = stats.totalSessions;
                document.getElementById('statTotalStudents').textContent = stats.totalStudents;
                document.getElementById('statTotalResources').textContent = stats.totalResources;
                document.getElementById('statRating').textContent = stats.rating.toFixed(1);
                document.getElementById('statFavorites').textContent = favCount;
            }

            const upcomingSessions = tutorManager.getUpcomingSessions(currentUser.id);
            const upcomingList = document.getElementById('upcomingSessionsList');
            
            if (upcomingSessions.length === 0) {
                upcomingList.innerHTML = '<p style="text-align: center; color: #6b7280;">No upcoming sessions</p>';
            } else {
                upcomingList.innerHTML = upcomingSessions.slice(0, 3).map(session => `
                    <div class="card" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4>${session.title}</h4>
                                <p style="color: #6b7280; margin: 8px 0;">üìÖ ${session.date} at ${session.time}</p>
                                <p style="color: #6b7280;">üë• ${session.currentStudents}/${session.maxStudents} students enrolled</p>
                            </div>
                            <span class="status-badge status-active">${session.status}</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        function loadProfile() {
            const tutor = tutorManager.getTutorProfile(currentUser.id);
            
            if (tutor) {
                document.getElementById('profileName').value = tutor.name;
                document.getElementById('profileEmail').value = tutor.email || currentUser.email;
                document.getElementById('profileDescription').value = tutor.description || '';
                document.getElementById('profileSubjects').value = tutor.subjects.join(', ');
            }
        }

        function handleProfileUpdate(event) {
            event.preventDefault();
            
            const subjects = document.getElementById('profileSubjects').value
                .split(',')
                .map(s => s.trim())
                .filter(s => s.length > 0);

            const result = tutorManager.updateProfile(currentUser.id, {
                name: document.getElementById('profileName').value,
                description: document.getElementById('profileDescription').value,
                subjects: subjects
            });

            const alertDiv = document.getElementById('profileAlert');
            if (result.success) {
                alertDiv.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
                auth.updateProfile(currentUser.id, { name: result.tutor.name });
                document.getElementById('userName').textContent = result.tutor.name;
            } else {
                alertDiv.innerHTML = `<div class="alert alert-error">${result.message}</div>`;
            }

            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        function loadSessions() {
            const sessions = tutorManager.getMySessions(currentUser.id);
            const sessionsList = document.getElementById('sessionsList');
            
            if (sessions.length === 0) {
                sessionsList.innerHTML = '<p style="text-align: center; color: #6b7280;">You haven\'t created any sessions yet</p>';
                return;
            }

            sessionsList.innerHTML = sessions.map(session => `
                <div class="card" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <h3>${session.title}</h3>
                            <p style="color: #6b7280; margin-top: 5px;">${session.description}</p>
                        </div>
                        <span class="status-badge status-${session.status === 'upcoming' ? 'active' : 'completed'}">${session.status}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 15px 0; padding: 15px; background: #f9fafb; border-radius: 8px;">
                        <div><strong>üìö Subject:</strong> ${session.subject}</div>
                        <div><strong>üìÖ Date:</strong> ${session.date}</div>
                        <div><strong>‚è∞ Time:</strong> ${session.time}</div>
                        <div><strong>‚è±Ô∏è Duration:</strong> ${session.duration}</div>
                        <div><strong>üë• Students:</strong> ${session.currentStudents}/${session.maxStudents}</div>
                        <div><strong>üìä Availability:</strong> ${session.maxStudents - session.currentStudents} spots left</div>
                    </div>
                    ${session.currentStudents > 0 ? `
                        <div style="margin: 15px 0;">
                            <h4 style="margin-bottom: 10px;">Enrolled Students:</h4>
                            <div id="students-${session.id}"></div>
                        </div>
                    ` : '<p style="color: #9ca3af; font-style: italic;">No students enrolled yet</p>'}
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="editSession(${session.id})" class="btn-outline">Edit</button>
                        <button onclick="viewSessionStudents(${session.id})" class="btn-primary">View Students</button>
                        ${session.status === 'upcoming' ? `
                            <button onclick="completeSession(${session.id})" class="btn-success">Mark Complete</button>
                        ` : ''}
                        <button onclick="deleteSession(${session.id})" class="btn-danger">Delete</button>
                    </div>
                </div>
            `).join('');

            // Load students for each session
            sessions.forEach(session => {
                if (session.currentStudents > 0) {
                    loadSessionStudents(session.id);
                }
            });
        }

        function loadSessionStudents(sessionId) {
            const students = tutorManager.getSessionStudents(sessionId);
            const container = document.getElementById(`students-${sessionId}`);
            
            if (container) {
                container.innerHTML = students.map(enrollment => `
                    <div style="display: inline-block; margin: 5px; padding: 8px 15px; background: #eef2ff; border-radius: 6px; color: #6366f1; font-size: 14px;">
                        ${enrollment.student.name}
                    </div>
                `).join('');
            }
        }

        function handleCreateSession(event) {
            event.preventDefault();
            
            const sessionData = {
                title: document.getElementById('sessionTitle').value,
                subject: document.getElementById('sessionSubject').value,
                description: document.getElementById('sessionDescription').value,
                date: document.getElementById('sessionDate').value,
                time: document.getElementById('sessionTime').value,
                duration: document.getElementById('sessionDuration').value,
                maxStudents: document.getElementById('sessionMaxStudents').value
            };

            const result = tutorManager.createSession(currentUser.id, sessionData);
            
            const alertDiv = document.getElementById('sessionAlert');
            if (result.success) {
                alertDiv.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
                document.getElementById('sessionForm').reset();
                loadSessions();
                loadDashboard();
            } else {
                alertDiv.innerHTML = `<div class="alert alert-error">${result.message}</div>`;
            }

            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        function editSession(sessionId) {
            const session = storage.getSessionById(sessionId);
            currentEditSessionId = sessionId;
            
            document.getElementById('editSessionId').value = sessionId;
            document.getElementById('editSessionTitle').value = session.title;
            document.getElementById('editSessionDescription').value = session.description;
            document.getElementById('editSessionDate').value = session.date;
            document.getElementById('editSessionTime').value = session.time;
            
            document.getElementById('editSessionModal').classList.add('active');
        }

        function handleUpdateSession(event) {
            event.preventDefault();
            
            const updates = {
                title: document.getElementById('editSessionTitle').value,
                description: document.getElementById('editSessionDescription').value,
                date: document.getElementById('editSessionDate').value,
                time: document.getElementById('editSessionTime').value
            };

            const result = tutorManager.updateSession(currentEditSessionId, updates);
            
            if (result.success) {
                alert(result.message);
                loadSessions();
                loadDashboard();
                closeEditModal();
            } else {
                alert(result.message);
            }
        }

        function deleteSession(sessionId) {
            if (!confirm('Are you sure you want to delete this session? All enrolled students will be notified.')) {
                return;
            }

            const result = tutorManager.deleteSession(sessionId);
            
            if (result.success) {
                alert(result.message);
                loadSessions();
                loadDashboard();
            } else {
                alert(result.message);
            }
        }

        function completeSession(sessionId) {
            if (!confirm('Mark this session as completed?')) return;
            
            const result = tutorManager.completeSession(sessionId);
            if (result.success) {
                alert('Session marked as completed!');
                loadSessions();
                loadDashboard();
            }
        }

        function viewSessionStudents(sessionId) {
            const students = tutorManager.getSessionStudents(sessionId);
            const session = storage.getSessionById(sessionId);
            
            if (students.length === 0) {
                alert('No students enrolled in this session yet.');
                return;
            }

            const studentList = students.map(e => `‚Ä¢ ${e.student.name} (${e.student.email})`).join('\n');
            alert(`Students enrolled in "${session.title}":\n\n${studentList}`);
        }

        function loadStudents() {
            const students = tutorManager.getAllStudents(currentUser.id);
            const studentsList = document.getElementById('studentsList');
            
            if (students.length === 0) {
                studentsList.innerHTML = '<p style="text-align: center; color: #6b7280;">No students have enrolled in your sessions yet</p>';
                return;
            }

            studentsList.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Email</th>
                            <th>Last Session</th>
                            <th>Enrolled On</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${students.map(student => `
                            <tr>
                                <td><strong>${student.name}</strong></td>
                                <td>${student.email}</td>
                                <td>${student.sessionTitle}</td>
                                <td>${new Date(student.enrollmentDate).toLocaleDateString()}</td>
                                <td>
                                    <button onclick="startChat(${student.id})" class="btn-outline">Message</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function loadResources() {
            const resources = tutorManager.getMyResources(currentUser.id);
            const resourcesList = document.getElementById('resourcesList');
            
            if (resources.length === 0) {
                resourcesList.innerHTML = '<p style="text-align: center; color: #6b7280;">You haven\'t uploaded any resources yet</p>';
                return;
            }

            resourcesList.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Subject</th>
                            <th>Type</th>
                            <th>Views</th>
                            <th>Downloads</th>
                            <th>Uploaded</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${resources.map(resource => `
                            <tr>
                                <td><strong>${resource.title}</strong></td>
                                <td>${resource.subject}</td>
                                <td><span class="subject-tag">${resource.fileType}</span></td>
                                <td>üëÅÔ∏è ${resource.views}</td>
                                <td>‚¨áÔ∏è ${resource.downloads}</td>
                                <td>${new Date(resource.uploadedAt).toLocaleDateString()}</td>
                                <td>
                                    <button onclick="deleteResource(${resource.id})" class="btn-danger">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function handleUpload(event) {
            event.preventDefault();
            
            const resourceData = {
                title: document.getElementById('resourceTitle').value,
                description: document.getElementById('resourceDescription').value,
                subject: document.getElementById('resourceSubject').value,
                fileType: document.getElementById('resourceFileType').value,
                fileName: document.getElementById('resourceFileName').value
            };

            const result = tutorManager.uploadResource(currentUser.id, resourceData);
            
            const alertDiv = document.getElementById('uploadAlert');
            if (result.success) {
                alertDiv.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
                document.getElementById('uploadForm').reset();
                loadResources();
                loadDashboard();
            } else {
                alertDiv.innerHTML = `<div class="alert alert-error">${result.message}</div>`;
            }

            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        function deleteResource(resourceId) {
            if (!confirm('Are you sure you want to delete this resource?')) return;
            
            const result = tutorManager.deleteResource(resourceId);
            if (result.success) {
                alert(result.message);
                loadResources();
                loadDashboard();
            }
        }

        function startChat(userId) {
            currentChatUser = userId;
            showSection('messages');
            loadConversation(userId);
        }

        function loadConversations() {
            const conversations = tutorManager.getConversations(currentUser.id);
            const chatList = document.getElementById('chatList');
            
            if (conversations.length === 0) {
                chatList.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No conversations yet</p>';
                return;
            }

            chatList.innerHTML = conversations.map(conv => `
                <div class="chat-item ${conv.unread ? 'unread' : ''} ${currentChatUser === conv.otherUser.id ? 'active' : ''}" onclick="loadConversation(${conv.otherUser.id})">
                    <strong>${conv.otherUser.name}</strong>
                    <p style="color: #6b7280; font-size: 13px; margin-top: 5px;">${conv.message.substring(0, 40)}...</p>
                </div>
            `).join('');
        }

        function loadConversation(userId) {
            currentChatUser = userId;
            const user = storage.getUserById(userId);
            const messages = tutorManager.getConversation(currentUser.id, userId);
            
            document.getElementById('chatHeader').style.display = 'block';
            document.getElementById('chatUserName').textContent = user.name;
            document.getElementById('chatInputContainer').style.display = 'flex';
            
            const chatMessages = document.getElementById('chatMessages');
            if (messages.length === 0) {
                chatMessages.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No messages yet. Start the conversation!</p>';
            } else {
                chatMessages.innerHTML = messages.map(msg => `
                    <div class="message ${msg.senderId === currentUser.id ? 'sent' : 'received'}">
                        <div class="message-bubble">
                            ${msg.message}
                        </div>
                        <div class="message-time">${new Date(msg.sentAt).toLocaleString()}</div>
                    </div>
                `).join('');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            tutorManager.markMessagesAsRead(currentUser.id, userId);
            updateMessagesBadge();
            loadConversations();
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !currentChatUser) return;
            
            tutorManager.sendMessage(currentUser.id, currentChatUser, message);
            input.value = '';
            loadConversation(currentChatUser);
        }

        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function loadNotifications() {
            const notifications = tutorManager.getNotifications(currentUser.id);
            const notificationsList = document.getElementById('notificationsList');
            
            if (notifications.length === 0) {
                notificationsList.innerHTML = '<p style="text-align: center; color: #6b7280;">No notifications</p>';
                return;
            }

            notificationsList.innerHTML = notifications.map(notif => `
                <li class="notification-item ${notif.read ? '' : 'unread'}">
                    <div class="notification-header">
                        <strong>${notif.title}</strong>
                        <span class="notification-time">${new Date(notif.createdAt).toLocaleString()}</span>
                    </div>
                    <p style="color: #4b5563; margin-top: 5px;">${notif.message}</p>
                    ${!notif.read ? `<button onclick="markNotificationAsRead(${notif.id})" class="btn-outline" style="margin-top: 10px;">Mark as Read</button>` : ''}
                </li>
            `).join('');
        }

        function markNotificationAsRead(notifId) {
            tutorManager.markNotificationAsRead(notifId);
            loadNotifications();
            updateNotificationsBadge();
        }

        function markAllAsRead() {
            tutorManager.markAllNotificationsAsRead(currentUser.id);
            loadNotifications();
            updateNotificationsBadge();
        }

        function updateNotificationsBadge() {
            const count = tutorManager.getUnreadNotificationsCount(currentUser.id);
            const badge = document.getElementById('notificationsBadge');
            if (count > 0) {
                badge.innerHTML = `<span class="notification-badge">${count}</span>`;
            } else {
                badge.innerHTML = '';
            }
        }

        function updateMessagesBadge() {
            const conversations = tutorManager.getConversations(currentUser.id);
            const unreadCount = conversations.filter(c => c.unread).length;
            const badge = document.getElementById('messagesBadge');
            if (unreadCount > 0) {
                badge.innerHTML = `<span class="notification-badge">${unreadCount}</span>`;
            } else {
                badge.innerHTML = '';
            }
        }

        function loadReviews() {
            const reviews = tutorManager.getMyReviews(currentUser.id);
            const stats = tutorManager.getReviewsStatistics(currentUser.id);
            
            // Display statistics
            const statsDiv = document.getElementById('reviewsStats');
            if (stats.totalReviews > 0) {
                statsDiv.innerHTML = `
                    <div class="rating-number">${stats.averageRating}</div>
                    <div class="rating-details">
                        <p style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">${stats.totalReviews} Review${stats.totalReviews !== 1 ? 's' : ''}</p>
                        ${[5, 4, 3, 2, 1].map(star => {
                            const count = stats.distribution[star];
                            const percentage = stats.totalReviews > 0 ? (count / stats.totalReviews) * 100 : 0;
                            return `
                                <div class="rating-bar">
                                    <span class="rating-label">${star} ‚≠ê</span>
                                    <div class="rating-bar-fill">
                                        <div class="rating-bar-fill-inner" style="width: ${percentage}%"></div>
                                    </div>
                                    <span class="rating-count">${count}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                statsDiv.innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚≠ê</div>
                        <p style="color: #6b7280; font-size: 18px;">No reviews yet</p>
                    </div>
                `;
            }
            
            // Display reviews
            const reviewsList = document.getElementById('reviewsList');
            if (reviews.length === 0) {
                reviewsList.innerHTML = '<div class="no-reviews">You haven\'t received any reviews yet. Complete sessions with students to start receiving feedback!</div>';
                return;
            }

            reviewsList.innerHTML = reviews.map(review => `
                <div class="review-card">
                    <div class="review-header">
                        <div>
                            <div class="review-author">${review.userName}</div>
                            <div class="review-date">${new Date(review.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                        </div>
                        <div class="review-rating">${'‚≠ê'.repeat(review.rating)}</div>
                    </div>
                    ${review.comment ? `<div class="review-comment">${review.comment}</div>` : '<div class="review-comment" style="font-style: italic; color: #9ca3af;">No comment provided</div>'}
                </div>
            `).join('');
        }

        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(el => {
                el.style.display = 'none';
            });
            
            document.querySelectorAll('.sidebar-menu a').forEach(el => {
                el.classList.remove('active');
            });
            
            const sections = {
                'dashboard': 'dashboardSection',
                'profile': 'profileSection',
                'sessions': 'sessionsSection',
                'create-session': 'createSessionSection',
                'students': 'studentsSection',
                'reviews': 'reviewsSection',
                'resources': 'resourcesSection',
                'upload': 'uploadSection',
                'messages': 'messagesSection',
                'notifications': 'notificationsSection'
            };
            
            if (sections[section]) {
                document.getElementById(sections[section]).style.display = 'block';
            }
            
            if (section === 'messages') {
                loadConversations();
            } else if (section === 'notifications') {
                loadNotifications();
            } else if (section === 'reviews') {
                loadReviews();
            }
        }

        function closeEditModal() {
            document.getElementById('editSessionModal').classList.remove('active');
        }

        setInterval(() => {
            updateNotificationsBadge();
            updateMessagesBadge();
        }, 30000);
    </script>
</body>
</html>