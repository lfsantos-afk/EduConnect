<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - EduConnect</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-content">
                <div class="logo">
                    <span class="logo-icon">üìö</span>
                    <span class="logo-text">EduConnect</span>
                </div>
                <div class="nav-links">
                    <a href="#" onclick="showSection('browse')">Browse Tutors</a>
                    <a href="#" onclick="showSection('sessions')">My Sessions</a>
                    <a href="#" onclick="showSection('resources')">Resources</a>
                    <a href="#" onclick="showSection('messages')">Messages <span id="messagesBadge"></span></a>
                </div>
                <div class="nav-buttons">
                    <button onclick="showSection('notifications')" class="btn-outline">
                        üîî <span id="notificationsBadge"></span>
                    </button>
                    <button onclick="auth.logout()" class="btn-primary">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard -->
    <div class="dashboard">
        <div class="dashboard-header">
            <div class="container">
                <div class="dashboard-welcome">
                    <div>
                        <h1>Welcome, <span id="userName"></span>!</h1>
                        <p>Ready to learn something new today?</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-content">
            <div class="container">
                <div class="dashboard-grid">
                    <!-- Sidebar -->
                    <aside class="sidebar">
                        <ul class="sidebar-menu">
                            <li><a href="#" class="active" onclick="showSection('browse')">
                                <span>üîç</span> Browse Tutors
                            </a></li>
                            <li><a href="#" onclick="showSection('favorites')">
                                <span>‚ù§Ô∏è</span> My Favorites
                            </a></li>
                            <li><a href="#" onclick="showSection('sessions')">
                                <span>üìÖ</span> My Sessions
                            </a></li>
                            <li><a href="#" onclick="showSection('resources')">
                                <span>üìö</span> Resources
                            </a></li>
                            <li><a href="#" onclick="showSection('upload')">
                                <span>‚¨ÜÔ∏è</span> Upload Resource
                            </a></li>
                            <li><a href="#" onclick="showSection('messages')">
                                <span>üí¨</span> Messages
                            </a></li>
                            <li><a href="#" onclick="showSection('notifications')">
                                <span>üîî</span> Notifications
                            </a></li>
                        </ul>
                    </aside>

                    <!-- Main Content -->
                    <main class="main-content">
                        <!-- Browse Tutors Section -->
                        <div id="browseSection" class="content-section">
                            <div class="content-header">
                                <h2>Available Tutors</h2>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="searchTutors" class="form-control" placeholder="Search tutors..." style="width: 250px;">
                                    <select id="filterSubject" class="form-control" style="width: 200px;">
                                        <option value="all">All Subjects</option>
                                    </select>
                                </div>
                            </div>
                            <div id="tutorsList" class="cards-grid"></div>
                        </div>

                        <!-- Favorites Section -->
                        <div id="favoritesSection" class="content-section" style="display: none;">
                            <div class="content-header">
                                <h2>My Favorite Tutors</h2>
                            </div>
                            <div id="favoritesList" class="cards-grid"></div>
                        </div>

                        <!-- My Sessions Section -->
                        <div id="sessionsSection" class="content-section" style="display: none;">
                            <div class="content-header">
                                <h2>My Enrolled Sessions</h2>
                            </div>
                            <div id="sessionsList"></div>
                        </div>

                        <!-- Resources Section -->
                        <div id="resourcesSection" class="content-section" style="display: none;">
                            <div class="content-header">
                                <h2>Educational Resources</h2>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="searchResources" class="form-control" placeholder="Search resources..." style="width: 250px;">
                                    <select id="filterResourceSubject" class="form-control" style="width: 200px;">
                                        <option value="all">All Subjects</option>
                                    </select>
                                </div>
                            </div>
                            <div id="resourcesList" class="cards-grid"></div>
                        </div>

                        <!-- Upload Resource Section -->
                        <div id="uploadSection" class="content-section" style="display: none;">
                            <div class="content-header">
                                <h2>Share Educational Resource</h2>
                            </div>
                            <div style="max-width: 600px;">
                                <div id="uploadAlert"></div>
                                <form id="uploadForm" onsubmit="handleUpload(event)">
                                    <div class="form-group">
                                        <label>Resource Title</label>
                                        <input type="text" id="resourceTitle" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Description</label>
                                        <textarea id="resourceDescription" class="form-control" rows="4" required></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Subject</label>
                                        <select id="resourceSubject" class="form-control" required>
                                            <option value="">Select a subject</option>
                                            <option value="Mathematics">Mathematics</option>
                                            <option value="Science">Science</option>
                                            <option value="Programming">Programming</option>
                                            <option value="English">English</option>
                                            <option value="History">History</option>
                                            <option value="Chemistry">Chemistry</option>
                                            <option value="Physics">Physics</option>
                                            <option value="Biology">Biology</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>File Type</label>
                                        <select id="resourceFileType" class="form-control" required>
                                            <option value="">Select type</option>
                                            <option value="PDF">PDF Document</option>
                                            <option value="DOC">Word Document</option>
                                            <option value="PPT">Presentation</option>
                                            <option value="XLS">Spreadsheet</option>
                                            <option value="Video">Video</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>File Name (simulation)</label>
                                        <input type="text" id="resourceFileName" class="form-control" required placeholder="e.g., my-notes.pdf">
                                    </div>
                                    <button type="submit" class="btn-primary">Upload Resource</button>
                                </form>
                            </div>
                        </div>

                        <!-- Messages Section -->
                        <div id="messagesSection" class="content-section" style="display: none;">
                            <div class="content-header">
                                <h2>Messages</h2>
                            </div>
                            <div class="chat-container">
                                <div class="chat-list" id="chatList">
                                    <p style="color: #6b7280; text-align: center; padding: 20px;">Select a conversation or start chatting with a tutor</p>
                                </div>
                                <div class="chat-window">
                                    <div id="chatHeader" class="chat-header" style="display: none;">
                                        <h3 id="chatUserName"></h3>
                                    </div>
                                    <div id="chatMessages" class="chat-messages"></div>
                                    <div id="chatInputContainer" class="chat-input" style="display: none;">
                                        <input type="text" id="messageInput" class="form-control" placeholder="Type your message...">
                                        <button onclick="sendMessage()" class="btn-primary">Send</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notifications Section -->
                        <div id="notificationsSection" class="content-section" style="display: none;">
                            <div class="content-header">
                                <h2>Notifications</h2>
                                <button onclick="markAllAsRead()" class="btn-outline">Mark All as Read</button>
                            </div>
                            <ul id="notificationsList" class="notifications-list"></ul>
                        </div>
                    </main>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="tutorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTutorName"></h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalTutorContent"></div>
        </div>
    </div>

    <div id="sessionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Available Sessions</h2>
                <button class="modal-close" onclick="closeSessionModal()">&times;</button>
            </div>
            <div id="modalSessionContent"></div>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Rate Your Experience</h2>
                <button class="modal-close" onclick="closeReviewModal()">&times;</button>
            </div>
            <div id="reviewModalContent">
                <div style="text-align: center; margin: 20px 0;">
                    <p style="color: #6b7280; margin-bottom: 20px;">How was your experience with <strong id="reviewTutorName"></strong>?</p>
                    <div class="stars-container" id="starsContainer" style="justify-content: center;">
                        <span class="star" data-rating="1" onclick="selectRating(1)">‚òÖ</span>
                        <span class="star" data-rating="2" onclick="selectRating(2)">‚òÖ</span>
                        <span class="star" data-rating="3" onclick="selectRating(3)">‚òÖ</span>
                        <span class="star" data-rating="4" onclick="selectRating(4)">‚òÖ</span>
                        <span class="star" data-rating="5" onclick="selectRating(5)">‚òÖ</span>
                    </div>
                </div>
                <form id="reviewForm" onsubmit="submitReview(event)" style="margin-top: 20px;">
                    <input type="hidden" id="reviewTutorId">
                    <input type="hidden" id="reviewRating" value="0">
                    <div class="form-group">
                        <label>Your Review (Optional)</label>
                        <textarea id="reviewComment" class="form-control" rows="4" placeholder="Share your experience with this tutor..."></textarea>
                    </div>
                    <div id="reviewAlert"></div>
                    <button type="submit" class="btn-primary" style="width: 100%;">Submit Review</button>
                </form>
            </div>
        </div>
    </div>

    <script src="js/storage.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/students.js"></script>
    <script src="js/tutors.js"></script>
    <script>
        // Check authentication
        if (!auth.requireStudent()) {
            // Will redirect if not authenticated or not a student
        }

        const currentUser = auth.getCurrentUser();
        let currentChatUser = null;

        // Initialize dashboard
        document.getElementById('userName').textContent = currentUser.name;
        loadTutors();
        loadSessions();
        loadResources();
        loadSubjectFilters();
        updateNotificationsBadge();
        updateMessagesBadge();

        // Search and filter functionality
        document.getElementById('searchTutors').addEventListener('input', filterTutors);
        document.getElementById('filterSubject').addEventListener('change', filterTutors);
        document.getElementById('searchResources').addEventListener('input', filterResources);
        document.getElementById('filterResourceSubject').addEventListener('change', filterResources);

        function loadSubjectFilters() {
            const subjects = studentManager.getAllSubjects();
            const filterSubject = document.getElementById('filterSubject');
            const filterResourceSubject = document.getElementById('filterResourceSubject');
            
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                filterSubject.appendChild(option);
                
                const option2 = option.cloneNode(true);
                filterResourceSubject.appendChild(option2);
            });
        }

        function loadTutors() {
            const tutors = studentManager.getAllTutors();
            displayTutors(tutors);
        }

        function displayTutors(tutors) {
            const tutorsList = document.getElementById('tutorsList');
            
            if (tutors.length === 0) {
                tutorsList.innerHTML = '<p style="text-align: center; color: #6b7280;">No tutors found</p>';
                return;
            }

            tutorsList.innerHTML = tutors.map(tutor => {
                const isFav = studentManager.isFavorite(currentUser.id, tutor.id);
                return `
                <div class="card">
                    <div class="card-header">
                        <div class="tutor-avatar">${tutor.photo}</div>
                        <div style="flex: 1;">
                            <div class="card-title">${tutor.name}</div>
                            <div class="rating">‚≠ê ${tutor.rating} ${tutor.totalReviews ? `(${tutor.totalReviews} reviews)` : ''}</div>
                        </div>
                        <button class="favorite-btn ${isFav ? 'active' : 'inactive'}" onclick="toggleFavorite(${tutor.id}, event)" title="${isFav ? 'Remove from favorites' : 'Add to favorites'}">
                            ${isFav ? '‚ù§Ô∏è' : 'ü§ç'}
                        </button>
                    </div>
                    <div class="card-body">
                        <p style="color: #6b7280; font-size: 14px;">${tutor.description.substring(0, 100)}...</p>
                        <div class="subjects-list">
                            ${tutor.subjects.slice(0, 3).map(subject => 
                                `<span class="subject-tag">${subject}</span>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="card-footer">
                        <button onclick="viewTutor(${tutor.id})" class="btn-outline" style="width: 48%;">View Profile</button>
                        <button onclick="viewSessions(${tutor.id})" class="btn-primary" style="width: 48%;">View Sessions</button>
                    </div>
                </div>
            `}).join('');
        }

        function filterTutors() {
            const searchQuery = document.getElementById('searchTutors').value;
            const subject = document.getElementById('filterSubject').value;
            
            let tutors;
            if (searchQuery) {
                tutors = studentManager.searchTutors(searchQuery);
            } else if (subject !== 'all') {
                tutors = studentManager.filterTutorsBySubject(subject);
            } else {
                tutors = studentManager.getAllTutors();
            }
            
            displayTutors(tutors);
        }

        function viewTutor(tutorId) {
            const tutor = studentManager.getTutorDetails(tutorId);
            const reviews = studentManager.getTutorReviews(tutorId);
            const canReview = studentManager.canReviewTutor(currentUser.id, tutorId);
            const isFav = studentManager.isFavorite(currentUser.id, tutorId);
            
            const modal = document.getElementById('tutorModal');
            document.getElementById('modalTutorName').textContent = tutor.name;
            
            let reviewsHTML = '';
            if (reviews.length > 0) {
                reviewsHTML = `
                    <h3 style="margin: 25px 0 15px;">Reviews (${reviews.length})</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${reviews.slice(0, 5).map(review => `
                            <div class="review-card">
                                <div class="review-header">
                                    <div>
                                        <div class="review-author">${review.userName}</div>
                                        <div class="review-date">${new Date(review.createdAt).toLocaleDateString()}</div>
                                    </div>
                                    <div class="review-rating">${'‚≠ê'.repeat(review.rating)}</div>
                                </div>
                                ${review.comment ? `<div class="review-comment">${review.comment}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                reviewsHTML = '<p style="text-align: center; color: #9ca3af; padding: 20px; font-style: italic;">No reviews yet</p>';
            }
            
            document.getElementById('modalTutorContent').innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 80px;">${tutor.photo}</div>
                    <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 10px;">
                        <div class="rating" style="font-size: 18px;">‚≠ê ${tutor.rating} Rating</div>
                        <button class="favorite-btn ${isFav ? 'active' : 'inactive'}" onclick="toggleFavoriteInModal(${tutor.id})" title="${isFav ? 'Remove from favorites' : 'Add to favorites'}">
                            ${isFav ? '‚ù§Ô∏è' : 'ü§ç'}
                        </button>
                    </div>
                    <p style="color: #6b7280; margin-top: 5px;">${tutor.totalStudents} Total Students ${tutor.totalReviews ? `‚Ä¢ ${tutor.totalReviews} Reviews` : ''}</p>
                </div>
                <h3 style="margin: 20px 0 10px;">About</h3>
                <p style="color: #4b5563;">${tutor.description}</p>
                <h3 style="margin: 20px 0 10px;">Subjects</h3>
                <div class="subjects-list">
                    ${tutor.subjects.map(subject => `<span class="subject-tag">${subject}</span>`).join('')}
                </div>
                ${reviewsHTML}
                <div style="margin-top: 30px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="viewSessions(${tutor.id})" class="btn-primary" style="flex: 1;">View Sessions</button>
                    <button onclick="startChat(${tutor.userId || tutor.id})" class="btn-secondary" style="flex: 1;">Send Message</button>
                    ${canReview ? `<button onclick="openReviewModal(${tutor.id}, '${tutor.name}')" class="btn-success" style="flex: 1;">Rate Tutor</button>` : ''}
                </div>
            `;
            modal.classList.add('active');
        }

        function viewSessions(tutorId) {
            const sessions = studentManager.getSessionsByTutor(tutorId);
            const tutor = studentManager.getTutorDetails(tutorId);
            const modal = document.getElementById('sessionModal');
            
            if (sessions.length === 0) {
                document.getElementById('modalSessionContent').innerHTML = 
                    '<p style="text-align: center; color: #6b7280; padding: 40px;">No upcoming sessions available</p>';
            } else {
                document.getElementById('modalSessionContent').innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h4>Sessions by ${tutor.name}</h4>
                    </div>
                    ${sessions.map(session => `
                        <div class="card" style="margin-bottom: 15px;">
                            <h4>${session.title}</h4>
                            <p style="color: #6b7280; margin: 10px 0;">${session.description}</p>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                                <div>
                                    <strong>üìÖ Date:</strong> ${session.date}
                                </div>
                                <div>
                                    <strong>‚è∞ Time:</strong> ${session.time}
                                </div>
                                <div>
                                    <strong>‚è±Ô∏è Duration:</strong> ${session.duration}
                                </div>
                                <div>
                                    <strong>üë• Spots:</strong> ${session.currentStudents}/${session.maxStudents}
                                </div>
                            </div>
                            <button onclick="enrollInSession(${session.id})" class="btn-primary" style="width: 100%;">
                                Enroll Now
                            </button>
                        </div>
                    `).join('')}
                `;
            }
            
            modal.classList.add('active');
        }

        function enrollInSession(sessionId) {
            if (!confirm('Are you sure you want to enroll in this session?')) return;
            
            const result = studentManager.enrollInSession(currentUser.id, sessionId);
            if (result.success) {
                alert(result.message);
                loadSessions();
                closeSessionModal();
            } else {
                alert(result.message);
            }
        }

        function loadSessions() {
            const enrollments = studentManager.getMyEnrollments(currentUser.id);
            const sessionsList = document.getElementById('sessionsList');
            
            if (enrollments.length === 0) {
                sessionsList.innerHTML = '<p style="text-align: center; color: #6b7280;">You haven\'t enrolled in any sessions yet</p>';
                return;
            }

            sessionsList.innerHTML = enrollments.map(enrollment => `
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <div class="tutor-avatar">${enrollment.tutor.photo}</div>
                        <div style="flex: 1;">
                            <div class="card-title">${enrollment.session.title}</div>
                            <div class="card-subtitle">with ${enrollment.tutor.name}</div>
                        </div>
                        <span class="status-badge status-active">Enrolled</span>
                    </div>
                    <div class="card-body">
                        <p style="color: #6b7280;">${enrollment.session.description}</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                            <div><strong>üìÖ Date:</strong> ${enrollment.session.date}</div>
                            <div><strong>‚è∞ Time:</strong> ${enrollment.session.time}</div>
                            <div><strong>‚è±Ô∏è Duration:</strong> ${enrollment.session.duration}</div>
                            <div><strong>üìç Status:</strong> ${enrollment.status}</div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button onclick="startChat(${enrollment.tutor.userId || enrollment.tutor.id})" class="btn-outline">Message Tutor</button>
                    </div>
                </div>
            `).join('');
        }

        function loadResources() {
            const resources = studentManager.getAllResources();
            displayResources(resources);
        }

        function displayResources(resources) {
            const resourcesList = document.getElementById('resourcesList');
            
            if (resources.length === 0) {
                resourcesList.innerHTML = '<p style="text-align: center; color: #6b7280;">No resources available</p>';
                return;
            }

            resourcesList.innerHTML = resources.map(resource => `
                <div class="card">
                    <div class="resource-header">
                        <span class="resource-icon">üìÑ</span>
                        <span class="resource-type">${resource.fileType}</span>
                    </div>
                    <h4 style="margin: 15px 0 10px;">${resource.title}</h4>
                    <p style="color: #6b7280; font-size: 14px; margin-bottom: 10px;">${resource.description.substring(0, 80)}...</p>
                    <div style="margin: 10px 0;">
                        <span class="subject-tag">${resource.subject}</span>
                    </div>
                    <p class="resource-author">by ${resource.authorName}</p>
                    <div style="display: flex; justify-content: space-between; color: #9ca3af; font-size: 13px; margin-top: 10px;">
                        <span>üëÅÔ∏è ${resource.views} views</span>
                        <span>‚¨áÔ∏è ${resource.downloads} downloads</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <button onclick="downloadResource(${resource.id})" class="btn-primary" style="width: 100%;">
                            Download
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function filterResources() {
            const searchQuery = document.getElementById('searchResources').value;
            const subject = document.getElementById('filterResourceSubject').value;
            
            let resources;
            if (searchQuery) {
                resources = studentManager.searchResources(searchQuery);
            } else if (subject !== 'all') {
                resources = studentManager.filterResourcesBySubject(subject);
            } else {
                resources = studentManager.getAllResources();
            }
            
            displayResources(resources);
        }

        function downloadResource(resourceId) {
            studentManager.viewResource(resourceId);
            const resource = studentManager.downloadResource(resourceId);
            alert(`Downloading: ${resource.fileName}\n\nNote: This is a demo. In a real application, the file would be downloaded.`);
        }

        function handleUpload(event) {
            event.preventDefault();
            
            const resourceData = {
                title: document.getElementById('resourceTitle').value,
                description: document.getElementById('resourceDescription').value,
                subject: document.getElementById('resourceSubject').value,
                fileType: document.getElementById('resourceFileType').value,
                fileName: document.getElementById('resourceFileName').value
            };

            const result = studentManager.uploadResource(currentUser.id, resourceData);
            
            const alertDiv = document.getElementById('uploadAlert');
            if (result.success) {
                alertDiv.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
                document.getElementById('uploadForm').reset();
                loadResources();
            } else {
                alertDiv.innerHTML = `<div class="alert alert-error">${result.message}</div>`;
            }

            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        function startChat(userId) {
            currentChatUser = userId;
            showSection('messages');
            loadConversation(userId);
        }

        function loadConversations() {
            const conversations = studentManager.getConversations(currentUser.id);
            const chatList = document.getElementById('chatList');
            
            if (conversations.length === 0) {
                chatList.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No conversations yet</p>';
                return;
            }

            chatList.innerHTML = conversations.map(conv => `
                <div class="chat-item ${conv.unread ? 'unread' : ''}" onclick="loadConversation(${conv.otherUser.id})">
                    <strong>${conv.otherUser.name}</strong>
                    <p style="color: #6b7280; font-size: 13px; margin-top: 5px;">${conv.message.substring(0, 40)}...</p>
                </div>
            `).join('');
        }

        function loadConversation(userId) {
            currentChatUser = userId;
            const user = storage.getUserById(userId);
            const messages = studentManager.getConversation(currentUser.id, userId);
            
            document.getElementById('chatHeader').style.display = 'block';
            document.getElementById('chatUserName').textContent = user.name;
            document.getElementById('chatInputContainer').style.display = 'flex';
            
            const chatMessages = document.getElementById('chatMessages');
            if (messages.length === 0) {
                chatMessages.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No messages yet. Start the conversation!</p>';
            } else {
                chatMessages.innerHTML = messages.map(msg => `
                    <div class="message ${msg.senderId === currentUser.id ? 'sent' : 'received'}">
                        <div class="message-bubble">
                            ${msg.message}
                        </div>
                        <div class="message-time">${new Date(msg.sentAt).toLocaleString()}</div>
                    </div>
                `).join('');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            studentManager.markMessagesAsRead(currentUser.id, userId);
            updateMessagesBadge();
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !currentChatUser) return;
            
            studentManager.sendMessage(currentUser.id, currentChatUser, message);
            input.value = '';
            loadConversation(currentChatUser);
        }

        function loadNotifications() {
            const notifications = studentManager.getNotifications(currentUser.id);
            const notificationsList = document.getElementById('notificationsList');
            
            if (notifications.length === 0) {
                notificationsList.innerHTML = '<p style="text-align: center; color: #6b7280;">No notifications</p>';
                return;
            }

            notificationsList.innerHTML = notifications.map(notif => `
                <li class="notification-item ${notif.read ? '' : 'unread'}">
                    <div class="notification-header">
                        <strong>${notif.title}</strong>
                        <span class="notification-time">${new Date(notif.createdAt).toLocaleString()}</span>
                    </div>
                    <p style="color: #4b5563; margin-top: 5px;">${notif.message}</p>
                    ${!notif.read ? `<button onclick="markNotificationAsRead(${notif.id})" class="btn-outline" style="margin-top: 10px;">Mark as Read</button>` : ''}
                </li>
            `).join('');
        }

        function markNotificationAsRead(notifId) {
            studentManager.markNotificationAsRead(notifId);
            loadNotifications();
            updateNotificationsBadge();
        }

        function markAllAsRead() {
            studentManager.markAllNotificationsAsRead(currentUser.id);
            loadNotifications();
            updateNotificationsBadge();
        }

        function updateNotificationsBadge() {
            const count = studentManager.getUnreadNotificationsCount(currentUser.id);
            const badge = document.getElementById('notificationsBadge');
            if (count > 0) {
                badge.innerHTML = `<span class="notification-badge">${count}</span>`;
            } else {
                badge.innerHTML = '';
            }
        }

        function updateMessagesBadge() {
            const conversations = studentManager.getConversations(currentUser.id);
            const unreadCount = conversations.filter(c => c.unread).length;
            const badge = document.getElementById('messagesBadge');
            if (unreadCount > 0) {
                badge.innerHTML = `<span class="notification-badge">${unreadCount}</span>`;
            } else {
                badge.innerHTML = '';
            }
        }

        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(el => {
                el.style.display = 'none';
            });
            
            // Remove active class from all menu items
            document.querySelectorAll('.sidebar-menu a').forEach(el => {
                el.classList.remove('active');
            });
            
            // Show selected section
            const sections = {
                'browse': 'browseSection',
                'favorites': 'favoritesSection',
                'sessions': 'sessionsSection',
                'resources': 'resourcesSection',
                'upload': 'uploadSection',
                'messages': 'messagesSection',
                'notifications': 'notificationsSection'
            };
            
            if (sections[section]) {
                document.getElementById(sections[section]).style.display = 'block';
            }
            
            // Load data for specific sections
            if (section === 'messages') {
                loadConversations();
            } else if (section === 'notifications') {
                loadNotifications();
            } else if (section === 'favorites') {
                loadFavorites();
            }
        }

        // Favorites Functions
        function toggleFavorite(tutorId, event) {
            event.stopPropagation();
            const isFav = studentManager.isFavorite(currentUser.id, tutorId);
            
            if (isFav) {
                studentManager.removeFavorite(currentUser.id, tutorId);
            } else {
                studentManager.addFavorite(currentUser.id, tutorId);
            }
            
            // Reload current view
            loadTutors();
            if (document.getElementById('favoritesSection').style.display !== 'none') {
                loadFavorites();
            }
        }

        function toggleFavoriteInModal(tutorId) {
            const isFav = studentManager.isFavorite(currentUser.id, tutorId);
            
            if (isFav) {
                studentManager.removeFavorite(currentUser.id, tutorId);
            } else {
                studentManager.addFavorite(currentUser.id, tutorId);
            }
            
            // Reload view
            viewTutor(tutorId);
            loadTutors();
        }

        function loadFavorites() {
            const favorites = studentManager.getFavoriteTutors(currentUser.id);
            const favoritesList = document.getElementById('favoritesList');
            
            if (favorites.length === 0) {
                favoritesList.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">You haven\'t added any favorites yet. Browse tutors and click the heart icon to save your favorites!</p>';
                return;
            }

            favoritesList.innerHTML = favorites.map(tutor => `
                <div class="card">
                    <div class="card-header">
                        <div class="tutor-avatar">${tutor.photo}</div>
                        <div style="flex: 1;">
                            <div class="card-title">${tutor.name}</div>
                            <div class="rating">‚≠ê ${tutor.rating} ${tutor.totalReviews ? `(${tutor.totalReviews} reviews)` : ''}</div>
                        </div>
                        <button class="favorite-btn active" onclick="toggleFavorite(${tutor.id}, event)" title="Remove from favorites">
                            ‚ù§Ô∏è
                        </button>
                    </div>
                    <div class="card-body">
                        <p style="color: #6b7280; font-size: 14px;">${tutor.description.substring(0, 100)}...</p>
                        <div class="subjects-list">
                            ${tutor.subjects.slice(0, 3).map(subject => 
                                `<span class="subject-tag">${subject}</span>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="card-footer">
                        <button onclick="viewTutor(${tutor.id})" class="btn-outline" style="width: 48%;">View Profile</button>
                        <button onclick="viewSessions(${tutor.id})" class="btn-primary" style="width: 48%;">View Sessions</button>
                    </div>
                </div>
            `).join('');
        }

        // Review Functions
        let selectedRating = 0;
        let currentReviewTutorId = null;

        function openReviewModal(tutorId, tutorName) {
            currentReviewTutorId = tutorId;
            selectedRating = 0;
            
            document.getElementById('reviewTutorId').value = tutorId;
            document.getElementById('reviewTutorName').textContent = tutorName;
            document.getElementById('reviewRating').value = 0;
            document.getElementById('reviewComment').value = '';
            document.getElementById('reviewAlert').innerHTML = '';
            
            // Reset stars
            document.querySelectorAll('#starsContainer .star').forEach(star => {
                star.classList.remove('active');
            });
            
            closeModal();
            document.getElementById('reviewModal').classList.add('active');
        }

        function selectRating(rating) {
            selectedRating = rating;
            document.getElementById('reviewRating').value = rating;
            
            // Update stars display
            document.querySelectorAll('#starsContainer .star').forEach(star => {
                const starRating = parseInt(star.getAttribute('data-rating'));
                if (starRating <= rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        function submitReview(event) {
            event.preventDefault();
            
            const rating = parseInt(document.getElementById('reviewRating').value);
            const comment = document.getElementById('reviewComment').value.trim();
            const tutorId = parseInt(document.getElementById('reviewTutorId').value);
            
            if (rating === 0) {
                document.getElementById('reviewAlert').innerHTML = '<div class="alert alert-error">Please select a rating</div>';
                return;
            }
            
            const result = studentManager.addReview(currentUser.id, tutorId, rating, comment);
            
            if (result.success) {
                document.getElementById('reviewAlert').innerHTML = `<div class="alert alert-success">${result.message}</div>`;
                setTimeout(() => {
                    closeReviewModal();
                    loadTutors();
                }, 1500);
            } else {
                document.getElementById('reviewAlert').innerHTML = `<div class="alert alert-error">${result.message}</div>`;
            }
        }

        function closeReviewModal() {
            document.getElementById('reviewModal').classList.remove('active');
        }

        function closeModal() {
            document.getElementById('tutorModal').classList.remove('active');
        }

        function closeSessionModal() {
            document.getElementById('sessionModal').classList.remove('active');
        }

        // Update notifications periodically
        setInterval(() => {
            updateNotificationsBadge();
            updateMessagesBadge();
        }, 30000);
    </script>
</body>
</html>